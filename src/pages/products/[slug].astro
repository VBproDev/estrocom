---
/* -------------------------
   Imports
-------------------------- */
import Layout from "../../layouts/Layout.astro";
import Text from "../../components/atoms/Text.astro";
import FeaturedProducts from "../../components/organisms/FeaturedProducts.astro";
import MakhanaBenefits from "../../components/molecules/MakhanaBenefits.astro";
import SattuBenefits from "../../components/molecules/SattuBenefits.astro";
import Outro from "../../components/organisms/Outro.astro";
import Footer from "../../components/organisms/Footer.astro";
import Button from "../../components/atoms/Button.astro";
import { data } from "../../utils/productData.js";
import Input from "../../components/atoms/Input.astro";
import { Image } from "astro:assets";

/* -------------------------
   Dynamic Route Generation
-------------------------- */
export async function getStaticPaths() {
  return data.map((product) => ({
    params: { slug: product.slug },
    props: product,
  }));
}

/* -------------------------
   Helper function for image gallery paths
-------------------------- */
function galleryLinkBuilder(n: number) {
  return `/assets/${slug}/image-gallery-${n}.webp`;
}

/* -------------------------
   Destructure props
-------------------------- */
const { name, price, image, others, slug, category } = Astro.props;

/* -------------------------
   Category-specific storytelling content
-------------------------- */
const categoryStory = {
  makhana: {
    origin: "Harvested from the pristine lotus ponds of Bihar",
    process:
      "Hand-picked at dawn, sun-dried naturally, and roasted in small batches using traditional methods that preserve every nutrient",
    promise: "Every bite connects you to 2,000 years of wellness wisdom",
    whyPure:
      "Unlike store-bought alternatives loaded with oil and salt, our makhana is pure, crunchy goodness straight from nature.",
    perfectFor:
      "Perfect for guilt-free snacking, festive celebrations, or adding nutritious crunch to your meals",
  },
  sattu: {
    origin: "Sourced from premium lotus fields in Bihar and UP",
    process:
      "Roasted using time-honored techniques and stone-ground to preserve its earthy flavor and complete protein profile",
    promise:
      "The same energy source that fueled wrestlers and farmers for generations",
    whyPure:
      "No additives, sugars or processing agents, 100% roasted gram flour with all its natural cooling properties and digestive benefits intact.",
    perfectFor:
      "Ideal for morning shakes, refreshing summer drinks, or traditional laddoos and parathas",
  },
};

const story = categoryStory[category];

/* -------------------------
   Product description
-------------------------- */
const description =
  category === "makhana"
    ? "FARM PURE HEALTHY MAKHANA offers you the finest quality fox nuts, carefully selected and prepared to maintain their crispness and flavor."
    : "Boost your energy naturally with Farm Pure Sattu, a powerhouse of high protein, essential minerals, and natural cooling properties.";

/* -------------------------
   Build image gallery links
-------------------------- */
const gallery = {
  first: galleryLinkBuilder(1),
  second: galleryLinkBuilder(2),
  third: galleryLinkBuilder(3),
};

/* -------------------------
   Capitalize category name
-------------------------- */
const categoryName = category.charAt(0).toUpperCase() + category.slice(1);

/* -------------------------
   Category-specific testimonials
-------------------------- */
const categoryTestimonial =
  category === "sattu"
    ? {
        review:
          "Nice product with some different taste and smell... A must have product in your home...",
        author: "Rajendra, Mumbai",
      }
    : {
        review:
          "Very fresh and crunchy. No smell as I have found in some other varieties...",
        author: "Madhu S.",
      };

/* -------------------------
   Structured Data for SEO
-------------------------- */
const structuredData = JSON.stringify(
  {
    "@context": "https://schema.org",
    "@type": "Product",
    name,
    image,
    description,
    sku: slug,
    brand: { "@type": "Brand", name: "Farmpure" },
    offers: {
      "@type": "Offer",
      url: `https://www.farmpure.net/products/${slug}`,
      priceCurrency: "INR",
      price,
      priceValidUntil: "2026-12-31",
      availability: "https://schema.org/InStock",
      itemCondition: "https://schema.org/NewCondition",
      seller: {
        "@type": "Organization",
        name: "Farmpure",
        url: "https://www.farmpure.net/",
      },
      shippingDetails: {
        "@type": "OfferShippingDetails",
        shippingRate: {
          "@type": "MonetaryAmount",
          value: "0",
          currency: "INR",
        },
        shippingDestination: { "@type": "DefinedRegion", addressCountry: "IN" },
        deliveryTime: {
          "@type": "ShippingDeliveryTime",
          handlingTime: {
            "@type": "QuantitativeValue",
            minValue: 0,
            maxValue: 1,
            unitCode: "d",
          },
          transitTime: {
            "@type": "QuantitativeValue",
            minValue: 2,
            maxValue: 5,
            unitCode: "d",
          },
        },
      },
      hasMerchantReturnPolicy: {
        "@type": "MerchantReturnPolicy",
        applicableCountry: "IN",
        returnPolicyCategory: "https://schema.org/MerchantReturnNotPermitted",
        returnFees: "https://schema.org/ReturnFeesCustomerResponsibility",
      },
    },
    aggregateRating: {
      "@type": "AggregateRating",
      ratingValue: category === "makhana" ? "4.6" : "4.7",
      reviewCount: category === "makhana" ? "587" : "534",
      bestRating: "5",
      worstRating: "1",
    },
    review: [
      {
        "@type": "Review",
        reviewRating: { "@type": "Rating", ratingValue: "5", bestRating: "5" },
        author: { "@type": "Person", name: "Amazon Customer" },
        publisher: {
          "@type": "Organization",
          name: categoryTestimonial.author,
        },
        reviewBody: categoryTestimonial.review,
      },
    ],
  },
  null,
  2,
);

const features = [
  { icon: "üî¨", label: "Lab Tested", color: "green" },
  { icon: "üåæ", label: "Farm Fresh", color: "amber" },
  { icon: "üö´", label: "No Additives", color: "blue" },
  { icon: "ü§ù", label: "Fair Trade", color: "purple" },
];
---

<Layout title={name} description={description}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={structuredData} />
  </Fragment>
</Layout>

<main>
  <!-- -------------------------
       Product Header Section
  -------------------------- -->
  <div class="container product-item-row">
    <div class="w-full flex flex-col justify-center pl-2">
      <!-- Trust Badge -->
      <div class="mb-4 mt-4 flex items-center justify-center">
        <span
          class="badge rounded-full bg-green-50 px-3 py-1.5 text-xs font-semibold text-green-700 border border-green-200"
        >
          ‚úì 100% Natural & Pure
        </span>
      </div>

      <!-- Product Image -->
      <div class="flex justify-center">
        <Image
          src={image}
          loading="eager"
          width={500}
          height={250}
          alt={name}
          class="w-full max-w-[45vh] h-auto object-contain"
        />
      </div>

      <!-- Product Name -->
      <div class="w-full mb-2">
        <Text type="h1" className="!text-3xl !font-semibold">
          {name}
        </Text>
      </div>

      <!-- Product Price with Social Proof -->
      <div class="w-full mb-4 flex items-center gap-3">
        <Text type="body" className="!font-extrabold !text-2xl">
          {`‚Çπ${price}`}
        </Text>
        <div class="flex items-center gap-1 text-sm text-gray-600">
          <span class="text-yellow-500">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
          <span class="font-medium"
            >{category === "makhana" ? "4.6" : "4.7"}</span
          >
          <span class="text-gray-500"
            >({category === "makhana" ? "587" : "534"} reviews)</span
          >
        </div>
      </div>

      <!-- Story Callout -->
      <div
        class="mb-6 bg-gradient-to-r from-amber-50 to-green-50 rounded-xl p-4 border-l-4 border-green-600"
      >
        <p class="text-sm font-medium text-gray-800 mb-2">
          <span class="text-green-700">üåæ {story.origin}</span>
        </p>
        <p class="text-sm text-gray-700 leading-relaxed">
          {story.process}. {story.promise}.
        </p>
      </div>

      <!-- Quantity Selector + Add to Cart + Buy Now -->
      <div class="flex flex-col gap-3">
        <div class="flex gap-3">
          <label for="product-quantity" class="sr-only">Quantity</label>
          <Input id="product-quantity" type="counter" value={1} class="w-24" />
          <Button
            id="add-to-cart-btn"
            type="secondary-inverted"
            class="flex-1 font-medium transition-all hover:scale-[1.02] active:scale-[0.98]"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="currentColor"
              class="bi bi-cart4"
              viewBox="0 0 16 16"
            >
              <path
                d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"
              ></path>
            </svg>
            Add to Cart
          </Button>
        </div>
        <Button
          id="buy-now-btn"
          type="secondary-inverted"
          class="w-full font-bold text-lg py-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl ring-2 ring-current"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            fill="currentColor"
            class="bi bi-lightning"
            viewBox="0 0 16 16"
          >
            <path
              d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641zM6.374 1 4.168 8.5H7.5a.5.5 0 0 1 .478.647L6.78 13.04 11.478 7H8a.5.5 0 0 1-.474-.658L9.306 1z"
            ></path>
          </svg>
          Buy Now
        </Button>
        <p class="text-sm text-gray-600 text-center mt-1">
          ‚úì Free shipping ‚Ä¢ ‚úì Tax inclusive ‚Ä¢ ‚úì Direct from farmers
        </p>
      </div>

      <div
        id="cart-status"
        class="sr-only"
        role="status"
        aria-live="polite"
        aria-atomic="true"
      >
      </div>

      <!-- Product Description with Story -->
      <div class="w-full mt-6 mb-8 space-y-4">
        <Text type="body" className="leading-relaxed">{description}</Text>
        <div class="bg-white rounded-lg p-4 border border-gray-200">
          <p class="text-sm text-gray-700 leading-relaxed mb-3">
            <strong class="text-gray-900">Why Farmpure is Different:</strong>
            {story.whyPure}
          </p>
          <p class="text-sm text-gray-700">
            <strong class="text-gray-900">Perfect For:</strong>
            {story.perfectFor}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- -------------------------
       Trust Indicators
  -------------------------- -->
  <div class="container pl-2">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
      {
        features.map(({ icon, label, color }) => (
          <div
            class={`rounded-lg p-3 text-center border transition-transform duration-300 hover:-translate-y-0.5 hover:shadow-md bg-${color}-50 border-${color}-100`}
          >
            <div class="text-2xl mb-1">{icon}</div>
            <div class="text-xs font-semibold text-gray-800">{label}</div>
          </div>
        ))
      }
    </div>
  </div>

  <!-- -------------------------
       Product Image Gallery
  -------------------------- -->
  <div class="container grid grid-cols-1 gap-4 pl-2">
    <div
      class="bg-cover bg-center bg-no-repeat rounded-2xl aspect-[1.5/1]"
      style={{ backgroundImage: `url(${gallery.first})` }}
    >
    </div>
    <div
      class="bg-cover bg-center bg-no-repeat rounded-2xl aspect-[1.5/1]"
      style={{ backgroundImage: `url(${gallery.second})` }}
    >
    </div>
    <div
      class="mb-4 bg-cover bg-center bg-no-repeat rounded-2xl aspect-[1.5/1]"
      style={{ backgroundImage: `url(${gallery.third})` }}
    >
    </div>
  </div>

  <!-- -------------------------
       The Story Behind Your Product
  -------------------------- -->
  <div class="container pl-2 mb-12">
    <div
      class="bg-gradient-to-br from-green-50 to-amber-50 rounded-2xl p-8 border border-green-100"
    >
      <div class="max-w-3xl">
        <Text type="h2" className="!text-2xl !font-bold mb-4 text-gray-900">
          From Our Farms to Your Family
        </Text>
        <div class="space-y-4 text-gray-700 leading-relaxed">
          <p>
            <strong>That's a promise.</strong> When you choose Farmpure, you're supporting
            {
              category === "makhana"
                ? "lotus farmers in Bihar who wake up at dawn to hand-pick each fox nut"
                : "small-scale farmers who've been growing Bengal gram for generations"
            }.
          </p>
          <p>
            We pay fair prices, ensure sustainable farming practices, and never
            compromise on quality. Every batch is tested for purity and packed
            with the same care we'd show our own families.
          </p>
          <div class="bg-white rounded-lg p-4 mt-4 border-l-4 border-green-600">
            <p class="font-medium text-gray-900 text-sm">
              üíö Your purchase directly supports farming families and preserves
              India's agricultural heritage.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- -------------------------
       Benefits Section
  -------------------------- -->
  <div class="container flex flex-col gap-4 pl-2">
    <div class="w-full mt-4 flex flex-col justify-center mb-4">
      <div class="w-full mb-2">
        <Text type="h2" className="!text-3xl !font-semibold">
          Health Benefits of {categoryName}
        </Text>
      </div>
      {category === "makhana" ? <MakhanaBenefits /> : <SattuBenefits />}
    </div>
  </div>

  <!-- -------------------------
       Testimonial Section
  -------------------------- -->
  <div class="container p-2 my-12">
    <div class="w-full max-w-2xl mx-auto text-center">
      <Text type="h2" className="!text-3xl !font-semibold mb-6">
        What Our Customers Say
      </Text>
      <blockquote
        class="bg-gradient-to-br from-green-50 to-white p-8 rounded-xl shadow-md border border-green-100"
      >
        <div class="text-yellow-500 text-2xl mb-3">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <Text type="body" className="!text-lg !italic mb-4">
          "{categoryTestimonial.review}"
        </Text>
        <Text type="body" className="!font-semibold text-gray-900">
          ‚Äî {categoryTestimonial.author}
        </Text>
      </blockquote>
    </div>
  </div>

  <!-- -------------------------
       Related Products
  -------------------------- -->
  <div class="container p-2">
    <Text type="h2" className="!text-3xl !font-semibold text-center mt-4">
      You Might Also Like
    </Text>
  </div>

  <div
    class="container flex lg:grid lg:grid-cols-2 lg:justify-center flex-wrap justify-between p-2"
  >
    {
      others.map((item) => (
        <div class="flex flex-col gap-2 w-full">
          <div class="w-full flex items-center justify-center">
            <Image
              src={item.image}
              alt={item.slug}
              height={100}
              width={100}
              class="w-full max-w-[400px]"
            />
          </div>
          <div class="flex flex-col gap-4 items-center text-center mb-1">
            <Text type="h3">{item.name}</Text>
            <a href={`/products/${item.slug}`}>
              <Button type="secondary-inverted">SEE PRODUCT</Button>
            </a>
          </div>
        </div>
      ))
    }
  </div>
</main>

<aside role="complementary" aria-labelledby="featured-products-heading">
  <div class="p-2 container">
    <Text
      type="h2"
      id="featured-products-heading"
      className="!text-3xl !font-semibold text-center mt-4"
    >
      Featured Products
    </Text>
    <FeaturedProducts />
  </div>
</aside>

<aside role="complementary" aria-label="About us">
  <Outro />
</aside>

<Footer />

<style>
  .badge {
    animation: subtle-pulse 3s ease-in-out infinite;
  }

  @keyframes subtle-pulse {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.02);
    }
  }
</style>

<script define:vars={{ name, price, image, slug }}>
  const addToCartBtn = document.getElementById("add-to-cart-btn");
  const buyNowBtn = document.getElementById("buy-now-btn");
  const quantityInput = document.getElementById("product-quantity");
  const cartStatus = document.getElementById("cart-status");

  function getCartItems() {
    const cartData = localStorage.getItem("cart");
    return cartData ? JSON.parse(cartData) : [];
  }

  function saveCartItems(items) {
    localStorage.setItem("cart", JSON.stringify(items));
    window.dispatchEvent(new CustomEvent("cartUpdated", { detail: items }));
  }

  function addItem(item, quantityToAdd) {
    const cartItems = getCartItems();
    const existingIndex = cartItems.findIndex((i) => i.name === item.name);

    if (existingIndex > -1) {
      cartItems[existingIndex].quantity =
        (cartItems[existingIndex].quantity || 1) + quantityToAdd;
    } else {
      cartItems.push({ ...item, quantity: quantityToAdd });
    }

    saveCartItems(cartItems);
  }

  if (addToCartBtn) {
    addToCartBtn.addEventListener("click", () => {
      let quantity = 1;

      if (quantityInput) {
        quantity = parseInt(quantityInput.value || "1");
      }

      addItem({ name, image, price: price.toString() }, quantity);

      if (cartStatus) {
        cartStatus.textContent = `Added ${quantity} ${
          quantity > 1 ? "items" : "item"
        } to cart`;
      }

      const originalText = addToCartBtn.textContent;
      addToCartBtn.textContent = "ADDED!";
      addToCartBtn.style.backgroundColor = "#4CAF50";

      setTimeout(() => {
        addToCartBtn.textContent = originalText;
        addToCartBtn.style.backgroundColor = "";
        if (cartStatus) cartStatus.textContent = "";
      }, 1000);
    });
  }

  if (buyNowBtn) {
    buyNowBtn.addEventListener("click", () => {
      let quantity = 1;

      if (quantityInput) {
        quantity = parseInt(quantityInput.value || "1");
      }

      addItem({ name, image, price: price.toString() }, quantity);

      if (cartStatus) {
        cartStatus.textContent = `Added ${quantity} ${
          quantity > 1 ? "items" : "item"
        } to cart. Redirecting to checkout...`;
      }

      window.location.href = "/checkout";
    });
  }
</script>
