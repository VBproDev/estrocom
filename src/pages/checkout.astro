---
/* =====================
   IMPORTS & ASSETS
   ===================== */
import Layout from "../layouts/Layout.astro";
import Button from "../components/atoms/Button.astro";
import Footer from "../components/organisms/Footer.astro";
import Text from "../components/atoms/Text.astro";
---

<Layout title="Checkout">

  <!-- ===========================
       META & SEO CONFIGURATION
       =========================== -->
  <Fragment slot="head">
    <meta name="robots" content="noindex, follow">
  </Fragment>

  <!-- ===========================
       MAIN CHECKOUT SECTION
       =========================== -->
  <main class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-12">
    <h1 class="sr-only">Checkout</h1>
    
    <div class="container flex justify-center">
      <div class="w-full max-w-lg">

        <!-- ===========================
             CHECKOUT PROGRESS INDICATOR
             =========================== -->
        <div class="mb-8 flex items-center justify-center gap-2">
          <div class="flex items-center gap-2">
            <div class="h-2 w-2 rounded-full bg-black"></div>
            <span class="text-sm font-medium text-black">Cart</span>
          </div>
          <div class="h-px w-12 bg-gray-300"></div>
          <div class="flex items-center gap-2">
            <div class="h-2 w-2 rounded-full bg-black"></div>
            <span class="text-sm font-medium text-black">Checkout</span>
          </div>
          <div class="h-px w-12 bg-gray-300"></div>
          <div class="flex items-center gap-2">
            <div class="h-2 w-2 rounded-full bg-gray-300"></div>
            <span class="text-sm font-medium text-gray-400">Complete</span>
          </div>
        </div>

        <!-- ===========================
             ORDER SUMMARY CARD
             =========================== -->
        <div class="rounded-2xl bg-white shadow-lg ring-1 ring-black/5 p-8 md:p-10">
          
          <!-- ===== HEADER ===== -->
          <div class="mb-8">
            <Text type="h2" className="!text-2xl !font-bold !leading-tight !tracking-tight">
              Order Summary
            </Text>
            <p class="mt-2 text-sm text-gray-500">Review your items before checkout</p>
          </div>

          <!-- ===== CART ITEMS ===== -->
          <div id="cart-items-summary" class="border-t border-gray-100 pt-6"></div>

          <!-- ===== EMPTY STATE ===== -->
          <div id="empty-cart" class="hidden py-12 text-center">
            <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <p class="mt-4 text-sm text-gray-500">Your cart is empty</p>
          </div>

          <div class="my-8 border-t border-gray-100"></div>

          <!-- ===== PRICE BREAKDOWN ===== -->
          <div class="space-y-3 mb-6">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Subtotal</span>
              <span id="subtotal" class="font-medium text-gray-900">₹ 0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Shipping</span>
              <span class="font-medium text-gray-900">Free</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Tax</span>
              <span class="font-medium text-gray-900">Calculated at checkout</span>
            </div>
          </div>

          <!-- ===== TOTAL SECTION ===== -->
          <div class="border-t border-gray-200 pt-6 mb-8">
            <div class="flex justify-between items-baseline">
              <Text type="h3" className="!text-lg !font-semibold !text-gray-900">
                Total
              </Text>
              <div class="text-right">
                <Text type="h2" id="summary-total" className="!text-3xl !font-bold !text-black">
                  ₹ 0
                </Text>
                <p class="text-xs text-gray-500 mt-1">Including all taxes</p>
              </div>
            </div>
          </div>

          <!-- ===== CHECKOUT BUTTON ===== -->
          <Button id="checkout" width="100%" type="secondary-inverted" className="!py-4 !text-base !font-semibold">
            PROCEED TO CHECKOUT
          </Button>

          <!-- ===== TRUST BADGES ===== -->
          <div class="mt-6 flex items-center justify-center gap-6 text-xs text-gray-500">
            <div class="flex items-center gap-1.5">
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
              </svg>
              <span>Secure checkout</span>
            </div>
            <div class="flex items-center gap-1.5">
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" />
              </svg>
              <span>Free shipping</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<!-- ===========================
     GLOBAL FOOTER
     =========================== -->
<Footer />

<!-- ===========================
     CHECKOUT LOGIC SCRIPT
     =========================== -->
<script>
  /* ---------------------
     IMPORT CART HELPERS
     --------------------- */
  import { 
    getCartItems, 
    calculateTotal, 
    updateCartItemQuantity,
    removeItemFromCart
  } from "../scripts/cart"; 

  /* ---------------------
     RENDER CHECKOUT SUMMARY
     --------------------- */
  function renderCheckoutSummary() {
    const cartItems = getCartItems();
    const container = document.getElementById("cart-items-summary");
    const emptyState = document.getElementById("empty-cart");

    if (!container) return;
    container.innerHTML = "";

    // Empty cart state
    if (cartItems.length === 0) {
      container.classList.add("hidden");
      emptyState?.classList.remove("hidden");
      const subtotalEl = document.getElementById("subtotal");
      const totalEl = document.getElementById("summary-total");
      if (subtotalEl) subtotalEl.textContent = "₹ 0";
      if (totalEl) totalEl.textContent = "₹ 0";
      return;
    }

    // Non-empty cart state
    emptyState?.classList.add("hidden");
    container.classList.remove("hidden");

    // Render cart items
    cartItems.forEach((item, index) => {
      const itemDiv = document.createElement("div");
      itemDiv.className = `flex justify-between items-start gap-4 ${index !== 0 ? 'pt-6' : ''} ${index !== cartItems.length - 1 ? 'pb-6 border-b border-gray-100' : ''}`;
      
      const currentQuantity = item.quantity || 1;
      
      itemDiv.innerHTML = `
        <div class="flex gap-4 items-start flex-1">
          <div class="relative">
            <img
              class="w-20 h-20 rounded-xl object-cover ring-1 ring-black/5"
              src="${item.image}"
              alt="${item.name}"
            />
          </div>
          <div class="flex flex-col gap-2 flex-1 pt-1">
            <div>
              <p class="font-semibold text-base leading-tight text-gray-900">${item.name}</p>
              <p class="font-medium text-sm text-gray-500">₹ ${item.price.toLocaleString()}</p>
            </div>
            
            <div class="flex items-center gap-3">
              <div class="flex items-center border border-gray-200 rounded-md">
                
                <button type="button" class="quantity-decrease-btn h-7 w-7 text-gray-600 hover:bg-gray-50 rounded-l-md" data-item-name="${item.name}" aria-label="Decrease quantity of ${item.name} (current quantity ${currentQuantity})">
                  <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 12H4"></path></svg>
                </button>
                
                <span class="px-3 text-sm font-medium text-gray-900" aria-hidden="true">${currentQuantity}</span>
                
                <button type="button" class="quantity-increase-btn h-7 w-7 text-gray-600 hover:bg-gray-50 rounded-r-md" data-item-name="${item.name}" aria-label="Increase quantity of ${item.name} (current quantity ${currentQuantity})">
                  <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                </button>
              </div>

              <button type="button" class="remove-item-btn text-sm font-medium text-gray-500 hover:text-red-600" data-item-name="${item.name}" aria-label="Remove ${item.name} from cart">
                Remove
              </button>
            </div>
          </div>
        </div>
        <p class="font-bold text-base text-gray-900 pt-1">₹ ${(Number(item.price) * currentQuantity).toLocaleString()}</p>
      `;
      
      container.appendChild(itemDiv);

      // Quantity / remove button listeners
      const decreaseBtn = itemDiv.querySelector(".quantity-decrease-btn");
      const increaseBtn = itemDiv.querySelector(".quantity-increase-btn");
      const removeBtn = itemDiv.querySelector(".remove-item-btn");

      if (decreaseBtn) {
        decreaseBtn.addEventListener("click", () => {
          const itemName = (decreaseBtn as HTMLElement).dataset.itemName;
          const newQuantity = (item.quantity || 1) - 1;
          if (itemName) {
            updateCartItemQuantity(itemName, newQuantity); 
            renderCheckoutSummary(); 
          }
        });
      }

      if (increaseBtn) {
        increaseBtn.addEventListener("click", () => {
          const itemName = (increaseBtn as HTMLElement).dataset.itemName;
          const newQuantity = (item.quantity || 1) + 1;
          if (itemName) {
            updateCartItemQuantity(itemName, newQuantity);
            renderCheckoutSummary(); 
          }
        });
      }

      if (removeBtn) {
        removeBtn.addEventListener("click", () => {
          const itemName = (removeBtn as HTMLElement).dataset.itemName;
          if (itemName) {
            removeItemFromCart(itemName);
            renderCheckoutSummary(); 
          }
        });
      }
    });

    // Update totals
    const total = calculateTotal(cartItems);
    const subtotalEl = document.getElementById("subtotal");
    const totalEl = document.getElementById("summary-total");
    if (subtotalEl) subtotalEl.textContent = `₹ ${total.toLocaleString()}`;
    if (totalEl) totalEl.textContent = `₹ ${total.toLocaleString()}`;
  }

  /* ---------------------
     INIT + EVENT HANDLERS
     --------------------- */
  renderCheckoutSummary();

  window.addEventListener('storage', (e) => {
    if (e.key === 'cart') renderCheckoutSummary();
  });

  window.addEventListener('cartUpdated', () => {
    renderCheckoutSummary();
  });

  const checkoutBtn = document.getElementById("checkout");
  if (checkoutBtn) {
    checkoutBtn.addEventListener("click", () => {
      console.log("Checkout clicked");
    });
  }
</script>