---
import { Image } from "astro:assets";
import Text from "../atoms/Text.astro";
import logo from "../../../public/assets/exported/icon-logo.png";
import Modal from "../molecules/Modal.astro";
import Button from "../atoms/Button.astro";
---

<div class="sticky top-0 z-10 w-full bg-gray-100 min-h-fit">
  <nav
    class="top-nav relative mx-auto flex w-[70%] min-w-[325px] max-h-[10vh] items-center justify-between border-b border-black/20 py-[clamp(5px,1vw,10px)]"
    aria-label="Main navigation"
  >
    <a href="/" class="flex items-center" aria-label="Home">
      <Image
        src={logo}
        alt="Back to homepage"
        width={150}
        height={150}
        loading="eager"
        class="w-[50px] cursor-pointer object-contain transition-transform duration-200 ease-in-out hover:scale-110"
      />
    </a>

    <div class="relative flex items-center">
      <div class="relative inline-block">
        <button
          id="cart-icon"
          type="button"
          aria-label="Shopping cart"
          aria-expanded="false"
          aria-haspopup="dialog"
          class="relative p-2 cursor-pointer transition-transform duration-200 ease-in-out hover:scale-110 rounded"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            fill="currentColor"
            class="bi bi-cart4"
            viewBox="0 0 16 16"
          >
            <path
              d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"
            ></path>
          </svg>
          <span
            id="cart-badge"
            class="absolute -right-2 -top-2 flex h-5 min-w-[20px] items-center justify-center rounded-full bg-orange-500 px-1.5 py-0.5 text-[11px] font-bold text-white scale-0 opacity-0 transition-all duration-200 ease-in-out"
            aria-live="polite"
            aria-atomic="true">0</span
          >
        </button>
      </div>
    </div>
  </nav>
</div>
<Modal id="cart">
  <div
    class="cart-wrapper absolute top-[90px] right-4 left-4 md:w-[400px] md:right-[150px] md:left-auto rounded-lg bg-white shadow-[0_4px_16px_rgba(0,0,0,0.15)] flex flex-col max-h-[80vh] animate-[slideIn_0.3s_ease-out]"
    role="dialog"
    aria-labelledby="cart-title"
    aria-modal="true"
  >
    <div
      class="flex items-center justify-between rounded-t-lg border-b border-gray-200 bg-white p-6"
    >
      <Text type="h6">
        <span id="cart-count" aria-live="polite" aria-atomic="true"
          >CART (0)</span
        >
      </Text>
      <Button
        id="remove-all-btn"
        class="text-sm opacity-60 transition-opacity duration-200 hover:opacity-100"
        aria-label="Remove all items from cart"
      >
        Remove all
      </Button>
    </div>

    <div
      id="cart-items-container"
      class="cart-items-scrollable flex flex-col flex-1 gap-0 overflow-y-auto px-6 py-4 min-h-[150px] max-h-[400px] [&::-webkit-scrollbar]:w-1.5 [&::-webkit-scrollbar-track]:bg-transparent [&::-webkit-scrollbar-thumb]:bg-[#d0d0d0] [&::-webkit-scrollbar-thumb]:rounded [&::-webkit-scrollbar-thumb:hover]:bg-[#b0b0b0]"
      role="list"
      aria-label="Cart items"
    >
      <div
        id="empty-cart-message"
        class="flex min-h-[150px] flex-col items-center justify-center p-8 text-center text-black/50"
        role="status"
        aria-live="polite"
      >
        <svg
          class="mb-4 opacity-30"
          width="64"
          height="64"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          aria-hidden="true"
        >
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path
            d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"
          ></path>
        </svg>
        <p class="text-sm opacity-70">Your cart is empty</p>
      </div>
    </div>

    <div class="rounded-b-lg border-t border-gray-200 bg-gray-50 p-6">
      <div class="mb-6 flex items-center justify-between">
        <Text type="h6">TOTAL</Text>
        <Text type="h6">
          <span id="cart-total" aria-live="polite" aria-atomic="true">â‚¹0</span>
        </Text>
      </div>
      <a href="/checkout" id="checkout-link">
        <Button
          width="100%"
          type="primary"
          id="checkout-btn"
          class="transition-all duration-200 ease-in-out disabled:cursor-not-allowed disabled:opacity-50"
          aria-label="Proceed to checkout"
        >
          CHECKOUT
        </Button>
      </a>
    </div>
  </div>
</Modal>

<style>
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .cart-item {
    @apply flex justify-between items-center w-full py-4 border-b border-gray-100 animate-[fadeIn_0.3s_ease] gap-3;
  }

  .cart-item:last-child {
    @apply border-b-0;
  }

  .cart-item-info {
    @apply flex gap-4 items-center flex-1 min-w-0;
  }

  .cart-item-image {
    @apply w-16 h-auto object-cover rounded-lg bg-gray-100 flex-shrink-0;
  }

  .cart-item-details {
    @apply flex flex-col gap-1 flex-1 min-w-0;
  }

  .cart-item-name {
    @apply font-bold text-[15px] overflow-hidden text-ellipsis whitespace-nowrap;
  }

  .cart-item-price {
    @apply text-black/50 text-sm;
  }

  .cart-item-actions {
    @apply flex gap-3 items-center flex-shrink-0;
  }

  .counter-wrapper {
    @apply flex gap-2 bg-gray-100 py-2 px-3 rounded items-center;
  }

  .counter-btn {
    @apply bg-transparent border-0 cursor-pointer text-sm text-black/50 px-1 transition-colors font-bold select-none hover:text-[#d87d4a] disabled:opacity-30 disabled:cursor-not-allowed;
  }

  .counter-value {
    @apply min-w-[20px] text-center font-bold text-[13px];
  }

  .remove-item-btn {
    @apply bg-transparent border-0 cursor-pointer text-black/40 p-1 transition-colors text-xs uppercase tracking-wide hover:text-[#d87d4a];
  }
</style>

<script>
  import { initCart, renderCart } from "../../scripts/cart";

  initCart();

  const cartIcon = document.getElementById("cart-icon") as HTMLButtonElement;
  const cartModal = document.getElementById("cart") as HTMLElement;
  const cartWrapper = document.querySelector(".cart-wrapper") as HTMLElement;
  const cartBadge = document.getElementById("cart-badge") as HTMLElement;
  const emptyCartMessage = document.getElementById(
    "empty-cart-message",
  ) as HTMLElement;
  const checkoutBtn = document.getElementById(
    "checkout-btn",
  ) as HTMLButtonElement;
  const checkoutLink = document.getElementById(
    "checkout-link",
  ) as HTMLAnchorElement;

  function updateCartBadge(count: number) {
    cartBadge.textContent = count.toString();
    cartIcon.setAttribute(
      "aria-label",
      `Shopping cart, ${count} ${count === 1 ? "item" : "items"}`,
    );

    if (count > 0) {
      cartBadge.classList.add("opacity-100", "scale-100");
    } else {
      cartBadge.classList.remove("opacity-100", "scale-100");
      cartIcon.setAttribute("aria-label", "Shopping cart, empty");
    }
  }

  function updateEmptyState() {
    const cartItemsContainer = document.getElementById(
      "cart-items-container",
    ) as HTMLElement;
    const cartItems = cartItemsContainer.querySelectorAll(".cart-item");
    const hasItems = cartItems.length > 0;

    if (emptyCartMessage) {
      if (hasItems) {
        emptyCartMessage.classList.add("hidden");
      } else {
        emptyCartMessage.classList.remove("hidden");
      }
    }

    if (checkoutBtn) {
      checkoutBtn.disabled = !hasItems;
    }
    if (checkoutLink) {
      if (hasItems) {
        checkoutLink.classList.remove("pointer-events-none");
        checkoutLink.removeAttribute("aria-disabled");
      } else {
        checkoutLink.classList.add("pointer-events-none");
        checkoutLink.setAttribute("aria-disabled", "true");
      }
    }
  }

  function openCart() {
    cartModal.style.display = "block";
    cartIcon.setAttribute("aria-expanded", "true");
    renderCart();
    updateEmptyState();

    setTimeout(() => {
      const firstFocusable = cartWrapper.querySelector(
        'button, a, input, [tabindex]:not([tabindex="-1"])',
      ) as HTMLElement;
      firstFocusable?.focus();
    }, 100);
  }

  function closeCart() {
    cartModal.style.display = "none";
    cartIcon.setAttribute("aria-expanded", "false");
    cartIcon.focus();
  }

  cartIcon.addEventListener("click", (e: MouseEvent) => {
    e.stopPropagation();
    if (cartModal.style.display === "none" || !cartModal.style.display) {
      openCart();
    } else {
      closeCart();
    }
  });

  cartModal.addEventListener("click", (e: MouseEvent) => {
    if (!cartWrapper.contains(e.target as Node)) {
      closeCart();
    }
  });

  cartWrapper.addEventListener("click", (e: MouseEvent) => {
    e.stopPropagation();
  });

  document.addEventListener("keydown", (e: KeyboardEvent) => {
    if (e.key === "Escape" && cartModal.style.display === "block") {
      closeCart();
    }
  });

  window.addEventListener("cartUpdated", (e: any) => {
    renderCart();
    updateEmptyState();

    const cartData = e.detail || { count: 0 };
    updateCartBadge(cartData.count || 0);
  });

  updateEmptyState();
</script>